"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var UtilMisc_1 = require("../UtilMisc");
var Payload_1 = require("../Payload");
var TupleActionStorageServiceABC_1 = require("./TupleActionStorageServiceABC");
var IndexedDb_1 = require("../storage/IndexedDb");
// ----------------------------------------------------------------------------
function now() {
    return new Date();
}
var DB_NAME = "tupleActions";
var ACTION_STORE = "tupleActions";
var ACTION_KEY_PATH = "scopeUuid";
/** Tuple Storage IndexedDB
 *
 * This class handles storing and retrieving tuples to/from indexed db.
 *
 */
var TupleActionStorageIndexedDbService = (function (_super) {
    __extends(TupleActionStorageIndexedDbService, _super);
    function TupleActionStorageIndexedDbService() {
        var _this = _super.call(this) || this;
        _this.openInProgressPromise = null;
        return _this;
    }
    TupleActionStorageIndexedDbService.prototype.storeAction = function (scope, tupleAction, payload) {
        var startTime = now();
        var retval = this.transaction(true)
            .then(function (tx) {
            var store = tx.objectStore(ACTION_STORE);
            return new Payload_1.Payload({}, [tupleAction]).toVortexMsg()
                .then(function (vortexMsg) {
                var item = {
                    scope: scope,
                    scopeUuid: scope + "|" + tupleAction.uuid,
                    encodedPayload: vortexMsg
                };
                var timeTaken = now() - startTime;
                console.log(UtilMisc_1.dateStr() + " IndexedDB: toVortexMsg took " + timeTaken + "ms ");
                startTime = now();
                return new Promise(function (resolve, reject) {
                    // Run the inserts
                    var response = store.put(item);
                    IndexedDb_1.addIndexedDbHandlers(response, function () {
                        reject(UtilMisc_1.dateStr() + " IndexedDB: saveTuples \"put\" error");
                        throw new IndexedDb_1.IDBException("Put error");
                    });
                    response.oncomplete = function () {
                        var timeTaken = now() - startTime;
                        console.log(UtilMisc_1.dateStr() + " IndexedDB: storeAction"
                            + (" took " + timeTaken + "ms (in thread)"));
                        resolve();
                    };
                });
            });
        });
        return retval;
    };
    TupleActionStorageIndexedDbService.prototype.loadNextAction = function () {
        return this.transaction(false)
            .then(function (tx) {
            var store = tx.objectStore(ACTION_STORE);
            return new Promise(function (resolve, reject) {
                // Run the inserts
                var response = store.openCursor();
                IndexedDb_1.addIndexedDbHandlers(response, function () {
                    reject(UtilMisc_1.dateStr() + " IndexedDB: saveTuples \"put\" error");
                    throw new IndexedDb_1.IDBException("Put error");
                });
                response.oncomplete = function (ev) {
                    var cursor = response.result || ev.target.result;
                    if (!!cursor == false) {
                        resolve(new Payload_1.Payload());
                        return;
                    }
                    Payload_1.Payload.fromVortexMsg(cursor.value.encodedPayload)
                        .then(function (payload) {
                        resolve(payload);
                        try {
                            tx.abort();
                        }
                        catch (e) {
                            console.log(e);
                        }
                    })
                        .catch(function (e) { return reject(e); });
                };
            });
        });
    };
    TupleActionStorageIndexedDbService.prototype.countActions = function () {
        return this.transaction(false)
            .then(function (tx) {
            var store = tx.objectStore(ACTION_STORE);
            return new Promise(function (resolve, reject) {
                // Run the inserts
                var response = store.count();
                IndexedDb_1.addIndexedDbHandlers(response, function () {
                    reject(UtilMisc_1.dateStr() + " IndexedDB: saveTuples \"put\" error");
                    throw new IndexedDb_1.IDBException("Put error");
                });
                response.oncomplete = function () {
                    resolve(response.result);
                };
            });
        });
    };
    TupleActionStorageIndexedDbService.prototype.deleteAction = function (scope, actionUuid) {
        var scopeUuid = scope + "|" + actionUuid;
        return this.transaction(true)
            .then(function (tx) {
            var store = tx.objectStore(ACTION_STORE);
            return new Promise(function (resolve, reject) {
                // Run the inserts
                var response = store.delete(scopeUuid);
                IndexedDb_1.addIndexedDbHandlers(response, function () {
                    reject(UtilMisc_1.dateStr() + " IndexedDB: saveTuples \"put\" error");
                    throw new IndexedDb_1.IDBException("Put error");
                });
                response.oncomplete = function () {
                    resolve();
                };
            });
        });
    };
    // ----------------------------------------------------------------------------
    // Open the indexed db database
    TupleActionStorageIndexedDbService.prototype.open = function () {
        var _this = this;
        if (this.isOpen())
            return Promise.resolve();
        if (this.openInProgressPromise != null)
            return this.openInProgressPromise;
        this.openInProgressPromise = new Promise(function (resolve, reject) {
            // DISP Store
            var request = IndexedDb_1.indexedDB.open(DB_NAME, 1);
            IndexedDb_1.addIndexedDbHandlers(request, function () {
                var msg = UtilMisc_1.dateStr() + " IndexedDB : \"" + DB_NAME + "\" "
                    + "Failed to open IndexedDB database";
                _this.openInProgressPromise = null;
                reject(msg);
                throw new IndexedDb_1.IDBException(msg);
            });
            request.onsuccess = function (event) {
                console.log(UtilMisc_1.dateStr() + " IndexedDB : \"" + DB_NAME + "\" Success opening DB");
                if (_this.db == null) {
                    _this.db = event.target.result;
                    _this.openInProgressPromise = null;
                    resolve();
                }
            };
            request.onupgradeneeded = function (event) {
                console.log(UtilMisc_1.dateStr() + " IndexedDB : \"" + DB_NAME + "\" Upgrading");
                var db = event.target.result;
                // SCHEMA for database points
                // Schema Version 1
                db.createObjectStore(ACTION_STORE, { keyPath: ACTION_KEY_PATH });
                console.log(UtilMisc_1.dateStr() + " IndexedDB : \"" + DB_NAME + "\" Upgrade Success");
            };
        });
        return this.openInProgressPromise;
    };
    // ----------------------------------------------------------------------------
    // Check if the DB is open
    TupleActionStorageIndexedDbService.prototype.isOpen = function () {
        return this.db != null;
    };
    TupleActionStorageIndexedDbService.prototype.close = function () {
        if (!this.isOpen()) {
            throw new Error("IndexedDB \"" + DB_NAME + "\" is not open");
        }
        this.db.close();
        this.db = null;
    };
    TupleActionStorageIndexedDbService.prototype.transaction = function (forWrite) {
        var _this = this;
        return this.open()
            .then(function () {
            // Get the Read Only case out the way, it's easy
            return _this.db.transaction(ACTION_STORE, forWrite ? "readwrite" : "readonly");
        });
    };
    TupleActionStorageIndexedDbService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [])
    ], TupleActionStorageIndexedDbService);
    return TupleActionStorageIndexedDbService;
}(TupleActionStorageServiceABC_1.TupleActionStorageServiceABC));
exports.TupleActionStorageIndexedDbService = TupleActionStorageIndexedDbService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHVwbGVBY3Rpb25TdG9yYWdlSW5kZXhlZERiU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlR1cGxlQWN0aW9uU3RvcmFnZUluZGV4ZWREYlNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBeUM7QUFDekMsd0NBQW9DO0FBQ3BDLHNDQUFtQztBQUNuQywrRUFBNEU7QUFDNUUsa0RBQW1GO0FBR25GLCtFQUErRTtBQUUvRTtJQUNJLE1BQU0sQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxJQUFNLE9BQU8sR0FBRyxjQUFjLENBQUM7QUFDL0IsSUFBTSxZQUFZLEdBQUcsY0FBYyxDQUFDO0FBQ3BDLElBQU0sZUFBZSxHQUFHLFdBQVcsQ0FBQztBQVFwQzs7OztHQUlHO0FBRUg7SUFBd0Qsc0RBQTRCO0lBS2hGO1FBQUEsWUFDSSxpQkFBTyxTQUdWO1FBUE8sMkJBQXFCLEdBQXlCLElBQUksQ0FBQzs7SUFPM0QsQ0FBQztJQUdELHdEQUFXLEdBQVgsVUFBWSxLQUFhLEVBQUUsV0FBMkIsRUFBRSxPQUFnQjtRQUNwRSxJQUFJLFNBQVMsR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUV0QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQzthQUM5QixJQUFJLENBQUMsVUFBQyxFQUFFO1lBQ0wsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUV6QyxNQUFNLENBQUMsSUFBSSxpQkFBTyxDQUFDLEVBQUUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFO2lCQUM5QyxJQUFJLENBQUMsVUFBQyxTQUFTO2dCQUVaLElBQUksSUFBSSxHQUE4QjtvQkFDbEMsS0FBSyxFQUFFLEtBQUs7b0JBQ1osU0FBUyxFQUFLLEtBQUssU0FBSSxXQUFXLENBQUMsSUFBTTtvQkFDekMsY0FBYyxFQUFFLFNBQVM7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LElBQUksQ0FBQztJQUNuQixDQUFDO0lBRUQsd0RBQVcsR0FBWCxVQUFZLFFBQWlCO1FBQTdCLGlCQVVDO1FBVEcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7YUFDYixJQUFJLENBQUM7WUFDRixnREFBZ0Q7WUFDaEQsTUFBTSxDQUFDLEtBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUN0QixZQUFZLEVBQUUsUUFBUSxHQUFHLFdBQVcsR0FBRyxVQUFVLENBQ3BELENBQUM7UUFDTixDQUFDLENBQUMsQ0FBQztJQUdYLENBQUM7SUE5TlEsa0NBQWtDO1FBRDlDLGlCQUFVLEVBQUU7O09BQ0Esa0NBQWtDLENBK045QztJQUFELHlDQUFDO0NBQUEsQUEvTkQsQ0FBd0QsMkRBQTRCLEdBK05uRjtBQS9OWSxnRkFBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQge2RhdGVTdHJ9IGZyb20gXCIuLi9VdGlsTWlzY1wiO1xuaW1wb3J0IHtQYXlsb2FkfSBmcm9tIFwiLi4vUGF5bG9hZFwiO1xuaW1wb3J0IHtUdXBsZUFjdGlvblN0b3JhZ2VTZXJ2aWNlQUJDfSBmcm9tIFwiLi9UdXBsZUFjdGlvblN0b3JhZ2VTZXJ2aWNlQUJDXCI7XG5pbXBvcnQge2FkZEluZGV4ZWREYkhhbmRsZXJzLCBJREJFeGNlcHRpb24sIGluZGV4ZWREQn0gZnJvbSBcIi4uL3N0b3JhZ2UvSW5kZXhlZERiXCI7XG5pbXBvcnQge1R1cGxlQWN0aW9uQUJDfSBmcm9tIFwiLi4vVHVwbGVBY3Rpb25cIjtcblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG5mdW5jdGlvbiBub3coKTogYW55IHtcbiAgICByZXR1cm4gbmV3IERhdGUoKTtcbn1cblxuY29uc3QgREJfTkFNRSA9IFwidHVwbGVBY3Rpb25zXCI7XG5jb25zdCBBQ1RJT05fU1RPUkUgPSBcInR1cGxlQWN0aW9uc1wiO1xuY29uc3QgQUNUSU9OX0tFWV9QQVRIID0gXCJzY29wZVV1aWRcIjtcblxuaW50ZXJmYWNlIFR1cGxlQWN0aW9uU3RvcmFnZVN0cnVjdEkge1xuICAgIHNjb3BlOiBzdHJpbmc7XG4gICAgc2NvcGVVdWlkOiBzdHJpbmc7XG4gICAgZW5jb2RlZFBheWxvYWQ6IHN0cmluZztcbn1cblxuLyoqIFR1cGxlIFN0b3JhZ2UgSW5kZXhlZERCXG4gKlxuICogVGhpcyBjbGFzcyBoYW5kbGVzIHN0b3JpbmcgYW5kIHJldHJpZXZpbmcgdHVwbGVzIHRvL2Zyb20gaW5kZXhlZCBkYi5cbiAqXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUdXBsZUFjdGlvblN0b3JhZ2VJbmRleGVkRGJTZXJ2aWNlIGV4dGVuZHMgVHVwbGVBY3Rpb25TdG9yYWdlU2VydmljZUFCQyB7XG4gICAgcHJpdmF0ZSBkYjogYW55O1xuICAgIHByaXZhdGUgb3BlbkluUHJvZ3Jlc3NQcm9taXNlOiBQcm9taXNlPHZvaWQ+IHwgbnVsbCA9IG51bGw7XG5cblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcigpO1xuXG5cbiAgICB9XG5cblxuICAgIHN0b3JlQWN0aW9uKHNjb3BlOiBzdHJpbmcsIHR1cGxlQWN0aW9uOiBUdXBsZUFjdGlvbkFCQywgcGF5bG9hZDogUGF5bG9hZCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBsZXQgc3RhcnRUaW1lID0gbm93KCk7XG5cbiAgICAgICAgbGV0IHJldHZhbCA9IHRoaXMudHJhbnNhY3Rpb24odHJ1ZSlcbiAgICAgICAgICAgIC50aGVuKCh0eCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKEFDVElPTl9TVE9SRSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFBheWxvYWQoe30sIFt0dXBsZUFjdGlvbl0pLnRvVm9ydGV4TXNnKClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHZvcnRleE1zZykgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaXRlbTogVHVwbGVBY3Rpb25TdG9yYWdlU3RydWN0SSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZTogc2NvcGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVVdWlkOiBgJHtzY29wZX18JHt0dXBsZUFjdGlvbi51dWlkfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZFBheWxvYWQ6IHZvcnRleE1zZ1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgdGltZVRha2VuID0gbm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtkYXRlU3RyKCl9IEluZGV4ZWREQjogdG9Wb3J0ZXhNc2cgdG9vayAke3RpbWVUYWtlbn1tcyBgKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gbm93KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSdW4gdGhlIGluc2VydHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSBzdG9yZS5wdXQoaXRlbSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRJbmRleGVkRGJIYW5kbGVycyhyZXNwb25zZSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoYCR7ZGF0ZVN0cigpfSBJbmRleGVkREI6IHNhdmVUdXBsZXMgXCJwdXRcIiBlcnJvcmApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSURCRXhjZXB0aW9uKFwiUHV0IGVycm9yXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uub25jb21wbGV0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRpbWVUYWtlbiA9IG5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtkYXRlU3RyKCl9IEluZGV4ZWREQjogc3RvcmVBY3Rpb25gXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGAgdG9vayAke3RpbWVUYWtlbn1tcyAoaW4gdGhyZWFkKWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gPFByb21pc2U8dm9pZD4gPiByZXR2YWw7XG4gICAgfVxuXG4gICAgbG9hZE5leHRBY3Rpb24oKTogUHJvbWlzZTxQYXlsb2FkPiB7XG5cblxuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2FjdGlvbihmYWxzZSlcbiAgICAgICAgICAgIC50aGVuKCh0eCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKEFDVElPTl9TVE9SRSk7XG5cblxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxQYXlsb2FkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSBpbnNlcnRzXG4gICAgICAgICAgICAgICAgICAgIGxldCByZXNwb25zZSA9IHN0b3JlLm9wZW5DdXJzb3IoKTtcblxuICAgICAgICAgICAgICAgICAgICBhZGRJbmRleGVkRGJIYW5kbGVycyhyZXNwb25zZSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGAke2RhdGVTdHIoKX0gSW5kZXhlZERCOiBzYXZlVHVwbGVzIFwicHV0XCIgZXJyb3JgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJREJFeGNlcHRpb24oXCJQdXQgZXJyb3JcIik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLm9uY29tcGxldGUgPSAoZXYpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjdXJzb3IgPSByZXNwb25zZS5yZXN1bHQgfHwgZXYudGFyZ2V0LnJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghIWN1cnNvciA9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IFBheWxvYWQoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBQYXlsb2FkLmZyb21Wb3J0ZXhNc2coY3Vyc29yLnZhbHVlLmVuY29kZWRQYXlsb2FkKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChwYXlsb2FkOiBQYXlsb2FkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocGF5bG9hZCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4LmFib3J0KCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jYXRjaChlID0+IHJlamVjdChlKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgfVxuXG4gICAgY291bnRBY3Rpb25zKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zYWN0aW9uKGZhbHNlKVxuICAgICAgICAgICAgLnRoZW4oKHR4KSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHN0b3JlID0gdHgub2JqZWN0U3RvcmUoQUNUSU9OX1NUT1JFKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxudW1iZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBSdW4gdGhlIGluc2VydHNcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3BvbnNlID0gc3RvcmUuY291bnQoKTtcblxuICAgICAgICAgICAgICAgICAgICBhZGRJbmRleGVkRGJIYW5kbGVycyhyZXNwb25zZSwgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGAke2RhdGVTdHIoKX0gSW5kZXhlZERCOiBzYXZlVHVwbGVzIFwicHV0XCIgZXJyb3JgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBJREJFeGNlcHRpb24oXCJQdXQgZXJyb3JcIik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLm9uY29tcGxldGUgPSAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlLnJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBkZWxldGVBY3Rpb24oc2NvcGU6IHN0cmluZywgYWN0aW9uVXVpZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGxldCBzY29wZVV1aWQgPSBgJHtzY29wZX18JHthY3Rpb25VdWlkfWA7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNhY3Rpb24odHJ1ZSlcbiAgICAgICAgICAgIC50aGVuKCh0eCkgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKEFDVElPTl9TVE9SRSk7XG5cblxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gUnVuIHRoZSBpbnNlcnRzXG4gICAgICAgICAgICAgICAgICAgIGxldCByZXNwb25zZSA9IHN0b3JlLmRlbGV0ZShzY29wZVV1aWQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGFkZEluZGV4ZWREYkhhbmRsZXJzKHJlc3BvbnNlLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoYCR7ZGF0ZVN0cigpfSBJbmRleGVkREI6IHNhdmVUdXBsZXMgXCJwdXRcIiBlcnJvcmApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IElEQkV4Y2VwdGlvbihcIlB1dCBlcnJvclwiKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uub25jb21wbGV0ZSA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgfVxuXG4vLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4vLyBPcGVuIHRoZSBpbmRleGVkIGRiIGRhdGFiYXNlXG4gICAgb3BlbigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKHRoaXMuaXNPcGVuKClcbiAgICAgICAgKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuXG4gICAgICAgIGlmICh0aGlzLm9wZW5JblByb2dyZXNzUHJvbWlzZSAhPSBudWxsKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMub3BlbkluUHJvZ3Jlc3NQcm9taXNlO1xuXG5cbiAgICAgICAgdGhpcy5vcGVuSW5Qcm9ncmVzc1Byb21pc2UgPSBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIC8vIERJU1AgU3RvcmVcblxuICAgICAgICAgICAgbGV0IHJlcXVlc3QgPSBpbmRleGVkREIub3BlbihEQl9OQU1FLCAxKTtcbiAgICAgICAgICAgIGFkZEluZGV4ZWREYkhhbmRsZXJzKHJlcXVlc3QsICgpID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbXNnID0gYCR7ZGF0ZVN0cigpfSBJbmRleGVkREIgOiBcIiR7REJfTkFNRX1cIiBgXG4gICAgICAgICAgICAgICAgICAgICsgYEZhaWxlZCB0byBvcGVuIEluZGV4ZWREQiBkYXRhYmFzZWA7XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuSW5Qcm9ncmVzc1Byb21pc2UgPSBudWxsO1xuICAgICAgICAgICAgICAgIHJlamVjdChtc2cpO1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBJREJFeGNlcHRpb24obXNnKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXF1ZXN0Lm9uc3VjY2VzcyA9IChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2RhdGVTdHIoKX0gSW5kZXhlZERCIDogXCIke0RCX05BTUV9XCIgU3VjY2VzcyBvcGVuaW5nIERCYCk7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZGIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmRiID0gZXZlbnQudGFyZ2V0LnJlc3VsdDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuSW5Qcm9ncmVzc1Byb21pc2UgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgcmVxdWVzdC5vbnVwZ3JhZGVuZWVkZWQgPSAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtkYXRlU3RyKCl9IEluZGV4ZWREQiA6IFwiJHtEQl9OQU1FfVwiIFVwZ3JhZGluZ2ApO1xuICAgICAgICAgICAgICAgIGxldCBkYiA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7XG5cbiAgICAgICAgICAgICAgICAvLyBTQ0hFTUEgZm9yIGRhdGFiYXNlIHBvaW50c1xuICAgICAgICAgICAgICAgIC8vIFNjaGVtYSBWZXJzaW9uIDFcbiAgICAgICAgICAgICAgICBkYi5jcmVhdGVPYmplY3RTdG9yZShBQ1RJT05fU1RPUkUsIHtrZXlQYXRoOiBBQ1RJT05fS0VZX1BBVEh9KTtcblxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2RhdGVTdHIoKX0gSW5kZXhlZERCIDogXCIke0RCX05BTUV9XCIgVXBncmFkZSBTdWNjZXNzYCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMub3BlbkluUHJvZ3Jlc3NQcm9taXNlO1xuICAgIH1cblxuLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuLy8gQ2hlY2sgaWYgdGhlIERCIGlzIG9wZW5cbiAgICBpc09wZW4oKTogYm9vbGVhbiB7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZGIgIT0gbnVsbDtcbiAgICB9XG5cbiAgICBjbG9zZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFcbiAgICAgICAgICAgICAgICB0aGlzLmlzT3BlbigpXG4gICAgICAgICkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbmRleGVkREIgXCIke0RCX05BTUV9XCIgaXMgbm90IG9wZW5gKVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGIuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5kYiA9IG51bGw7XG4gICAgfVxuXG4gICAgdHJhbnNhY3Rpb24oZm9yV3JpdGU6IGJvb2xlYW4pOiBQcm9taXNlPGFueT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5vcGVuKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIFJlYWQgT25seSBjYXNlIG91dCB0aGUgd2F5LCBpdCdzIGVhc3lcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYi50cmFuc2FjdGlvbihcbiAgICAgICAgICAgICAgICAgICAgQUNUSU9OX1NUT1JFLCBmb3JXcml0ZSA/IFwicmVhZHdyaXRlXCIgOiBcInJlYWRvbmx5XCJcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG5cblxuICAgIH1cbn1cbiJdfQ==