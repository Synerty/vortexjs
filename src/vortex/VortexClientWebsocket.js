"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Payload_1 = require("./Payload");
var VortexClientABC_1 = require("./VortexClientABC");
var UtilMisc_1 = require("./UtilMisc");
var VortexClientWebsocket = (function (_super) {
    __extends(VortexClientWebsocket, _super);
    function VortexClientWebsocket(vortexStatusService, zone, url) {
        var _this = _super.call(this, vortexStatusService, zone, url) || this;
        _this.Socket = WebSocket || MozWebSocket;
        _this.socket = null;
        _this.lastReconnectDate = Date.parse("01-Jan-2017");
        _this.unsentBuffer = [];
        return _this;
    }
    Object.defineProperty(VortexClientWebsocket.prototype, "isReady", {
        get: function () {
            return this.socket != null && this.socket.readyState === this.Socket.OPEN;
        },
        enumerable: true,
        configurable: true
    });
    VortexClientWebsocket.prototype.sendVortexMsg = function (vortexMsgs) {
        this.unsentBuffer.add(vortexMsgs);
        if (!this.isReady)
            this.createSocket();
        this.sendMessages();
    };
    VortexClientWebsocket.prototype.sendMessages = function () {
        while (this.unsentBuffer.length !== 0) {
            if (!this.isReady)
                return;
            var vortexMsg = this.unsentBuffer.shift();
            this.socket.send(vortexMsg + '.');
        }
    };
    VortexClientWebsocket.prototype.shutdown = function () {
        this.createSocket();
    };
    VortexClientWebsocket.prototype.createSocket = function () {
        var _this = this;
        // If we're already connecting, then do nothing
        if (this.socket && this.socket.readyState === this.Socket.CONNECTING)
            return;
        // If we're open then close
        if (this.socket && this.socket.readyState === this.Socket.OPEN)
            this.socket.close();
        this.socket = null;
        this.vortexStatusService.setOnline(false);
        // If the vortex is shutdown then don't reconnect
        if (this.closed) {
            this.vortexStatusService.logInfo("WebSocket, Vortex is shutdown");
            return;
        }
        // Don't continually reconnect
        var reconnectDiffMs = Date.now() - this.lastReconnectDate;
        if (reconnectDiffMs < VortexClientWebsocket.RECONNECT_BACKOFF) {
            setTimeout(function () { return _this.createSocket(); }, VortexClientWebsocket.RECONNECT_BACKOFF - reconnectDiffMs + 10);
            return;
        }
        this.lastReconnectDate = Date.now();
        // Prepare the args to send
        var args = {
            "vortexUuid": this.uuid,
            "vortexName": this.name
        };
        // Construct + open the socket
        this.vortexStatusService.logInfo("WebSocket, connecting to " + this.url);
        this.socket = new this.Socket(this.url + UtilMisc_1.getFiltStr(args), []);
        this.socket.binaryType = "arraybuffer";
        this.socket.addEventListener('open', function (event) { return _this.onOpen(event); });
        this.socket.addEventListener('message', function (event) { return _this.onMessage(event); });
        this.socket.addEventListener('close', function (event) { return _this.onClose(event); });
        this.socket.addEventListener('error', function (event) { return _this.onError(event); });
    };
    VortexClientWebsocket.prototype.onMessage = function (event) {
        var _this = this;
        if (event.data.length == null) {
            this.vortexStatusService.logError("WebSocket, We've received a websocket binary message," +
                " we expect a unicode");
            return;
        }
        // If the server sends us a '.', that's a heart beat, return it.
        if (event.data === '.') {
            this.beat();
            this.socket != null && this.socket.send('.');
            return;
        }
        Payload_1.Payload.fromVortexMsg(event.data)
            .then(function (payload) { return _this.receive(payload); })
            .catch(function (e) { return console.log("ERROR VortexClientWebsocket: " + e); });
    };
    VortexClientWebsocket.prototype.onOpen = function (event) {
        this.vortexStatusService.setOnline(true);
        this.sendMessages();
    };
    VortexClientWebsocket.prototype.onClose = function (event) {
        this.vortexStatusService.logInfo("WebSocket, closed");
        if (!(this.socket && this.socket.readyState === this.Socket.OPEN))
            this.vortexStatusService.setOnline(false);
        // The base class will reconnect
    };
    VortexClientWebsocket.prototype.onError = function (event) {
        this.vortexStatusService.logError(event.error ? event.error : "WebSocket, No error message");
        // onClose will get called as well
    };
    VortexClientWebsocket.RECONNECT_BACKOFF = 5000; // milliseconds
    return VortexClientWebsocket;
}(VortexClientABC_1.VortexClientABC));
exports.VortexClientWebsocket = VortexClientWebsocket;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVm9ydGV4Q2xpZW50V2Vic29ja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiVm9ydGV4Q2xpZW50V2Vic29ja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEscUNBQWtDO0FBQ2xDLHFEQUFrRDtBQUdsRCx1Q0FBc0M7QUFPdEM7SUFBMkMseUNBQWU7SUFXdEQsK0JBQVksbUJBQXdDLEVBQ3hDLElBQVksRUFDWixHQUFXO1FBRnZCLFlBR0ksa0JBQU0sbUJBQW1CLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxTQUV4QztRQVpPLFlBQU0sR0FBRyxTQUFTLElBQUksWUFBWSxDQUFDO1FBQ25DLFlBQU0sR0FBcUIsSUFBSSxDQUFDO1FBRWhDLHVCQUFpQixHQUFXLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFdEQsa0JBQVksR0FBYSxFQUFFLENBQUM7O0lBT3BDLENBQUM7SUFFRCxzQkFBSSwwQ0FBTzthQUFYO1lBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQzlFLENBQUM7OztPQUFBO0lBRVMsNkNBQWEsR0FBdkIsVUFBd0IsVUFBb0I7UUFDeEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFbEMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ2QsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRXhCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRU8sNENBQVksR0FBcEI7UUFDSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3BDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDZCxN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Tyx1Q0FBTyxHQUFmLFVBQWdCLEtBQUs7UUFDakIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ3RELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxLQUFLLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QyxnQ0FBZ0M7SUFDcEMsQ0FBQztJQUVPLHVDQUFPLEdBQWYsVUFBZ0IsS0FBSztRQUNqQixJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssR0FBRyw2QkFBNkIsQ0FBQyxDQUFDO1FBQzdGLGtDQUFrQztJQUN0QyxDQUFDO0lBM0h1Qix1Q0FBaUIsR0FBRyxJQUFJLENBQUMsQ0FBQyxlQUFlO0lBOEhyRSw0QkFBQztDQUFBLEFBaElELENBQTJDLGlDQUFlLEdBZ0l6RDtBQWhJWSxzREFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1BheWxvYWR9IGZyb20gXCIuL1BheWxvYWRcIjtcbmltcG9ydCB7Vm9ydGV4Q2xpZW50QUJDfSBmcm9tIFwiLi9Wb3J0ZXhDbGllbnRBQkNcIjtcbmltcG9ydCB7Tmdab25lfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHtWb3J0ZXhTdGF0dXNTZXJ2aWNlfSBmcm9tIFwiLi9Wb3J0ZXhTdGF0dXNTZXJ2aWNlXCI7XG5pbXBvcnQge2dldEZpbHRTdHJ9IGZyb20gXCIuL1V0aWxNaXNjXCI7XG5cbi8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9XZWJTb2NrZXRcblxuZGVjbGFyZSBjb25zdCBXZWJTb2NrZXQ6IGFueTtcbmRlY2xhcmUgY29uc3QgTW96V2ViU29ja2V0OiBhbnk7XG5cbmV4cG9ydCBjbGFzcyBWb3J0ZXhDbGllbnRXZWJzb2NrZXQgZXh0ZW5kcyBWb3J0ZXhDbGllbnRBQkMge1xuXG4gICAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgUkVDT05ORUNUX0JBQ0tPRkYgPSA1MDAwOyAvLyBtaWxsaXNlY29uZHNcblxuICAgIHByaXZhdGUgU29ja2V0ID0gV2ViU29ja2V0IHx8IE1veldlYlNvY2tldDtcbiAgICBwcml2YXRlIHNvY2tldDogV2ViU29ja2V0IHwgbnVsbCA9IG51bGw7XG5cbiAgICBwcml2YXRlIGxhc3RSZWNvbm5lY3REYXRlOiBudW1iZXIgPSBEYXRlLnBhcnNlKFwiMDEtSmFuLTIwMTdcIik7XG5cbiAgICBwcml2YXRlIHVuc2VudEJ1ZmZlcjogc3RyaW5nW10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKHZvcnRleFN0YXR1c1NlcnZpY2U6IFZvcnRleFN0YXR1c1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgem9uZTogTmdab25lLFxuICAgICAgICAgICAgICAgIHVybDogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKHZvcnRleFN0YXR1c1NlcnZpY2UsIHpvbmUsIHVybCk7XG5cbiAgICB9XG5cbiAgICBnZXQgaXNSZWFkeSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc29ja2V0ICE9IG51bGwgJiYgdGhpcy5zb2NrZXQucmVhZHlTdGF0ZSA9PT0gdGhpcy5Tb2NrZXQuT1BFTjtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2VuZFZvcnRleE1zZyh2b3J0ZXhNc2dzOiBzdHJpbmdbXSk6IHZvaWQge1xuICAgICAgICB0aGlzLnVuc2VudEJ1ZmZlci5hZGQodm9ydGV4TXNncyk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmlzUmVhZHkpXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVNvY2tldCgpO1xuXG4gICAgICAgIHRoaXMuc2VuZE1lc3NhZ2VzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZW5kTWVzc2FnZXMoKSB7XG4gICAgICAgIHdoaWxlICh0aGlzLnVuc2VudEJ1ZmZlci5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1JlYWR5KVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgbGV0IHZvcnRleE1zZyA9IHRoaXMudW5zZW50QnVmZmVyLnNoaWZ0KCk7XG4gICAgICAgICAgICB0aGlzLnNvY2tldC5zZW5kKHZvcnRleE1zZyArICcuJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2h1dGRvd24oKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY3JlYXRlU29ja2V0KCk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGNyZWF0ZVNvY2tldCgpOiB2b2lkIHtcbiAgICAgICAgLy8gSWYgd2UncmUgYWxyZWFkeSBjb25uZWN0aW5nLCB0aGVuIGRvIG5vdGhpbmdcbiAgICAgICAgaWYgKHRoaXMuc29ja2V0ICYmIHRoaXMuc29ja2V0LnJlYWR5U3RhdGUgPT09IHRoaXMuU29ja2V0LkNPTk5FQ1RJTkcpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgLy8gSWYgd2UncmUgb3BlbiB0aGVuIGNsb3NlXG4gICAgICAgIGlmICh0aGlzLnNvY2tldCAmJiB0aGlzLnNvY2tldC5yZWFkeVN0YXRlID09PSB0aGlzLlNvY2tldC5PUEVOKVxuICAgICAgICAgICAgdGhpcy5zb2NrZXQuY2xvc2UoKTtcblxuICAgICAgICB0aGlzLnNvY2tldCA9IG51bGw7XG5cbiAgICAgICAgdGhpcy52b3J0ZXhTdGF0dXNTZXJ2aWNlLnNldE9ubGluZShmYWxzZSk7XG5cbiAgICAgICAgLy8gSWYgdGhlIHZvcnRleCBpcyBzaHV0ZG93biB0aGVuIGRvbid0IHJlY29ubmVjdFxuICAgICAgICBpZiAodGhpcy5jbG9zZWQpIHtcbiAgICAgICAgICAgIHRoaXMudm9ydGV4U3RhdHVzU2VydmljZS5sb2dJbmZvKFwiV2ViU29ja2V0LCBWb3J0ZXggaXMgc2h1dGRvd25cIik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBEb24ndCBjb250aW51YWxseSByZWNvbm5lY3RcbiAgICAgICAgbGV0IHJlY29ubmVjdERpZmZNcyA9IERhdGUubm93KCkgLSB0aGlzLmxhc3RSZWNvbm5lY3REYXRlO1xuICAgICAgICBpZiAocmVjb25uZWN0RGlmZk1zIDwgVm9ydGV4Q2xpZW50V2Vic29ja2V0LlJFQ09OTkVDVF9CQUNLT0ZGKSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuY3JlYXRlU29ja2V0KCksXG4gICAgICAgICAgICAgICAgVm9ydGV4Q2xpZW50V2Vic29ja2V0LlJFQ09OTkVDVF9CQUNLT0ZGIC0gcmVjb25uZWN0RGlmZk1zICsgMTApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5sYXN0UmVjb25uZWN0RGF0ZSA9IERhdGUubm93KCk7XG5cbiAgICAgICAgLy8gUHJlcGFyZSB0aGUgYXJncyB0byBzZW5kXG4gICAgICAgIGxldCBhcmdzID0ge1xuICAgICAgICAgICAgXCJ2b3J0ZXhVdWlkXCI6IHRoaXMudXVpZCxcbiAgICAgICAgICAgIFwidm9ydGV4TmFtZVwiOiB0aGlzLm5hbWVcbiAgICAgICAgfTtcblxuICAgICAgICAvLyBDb25zdHJ1Y3QgKyBvcGVuIHRoZSBzb2NrZXRcbiAgICAgICAgdGhpcy52b3J0ZXhTdGF0dXNTZXJ2aWNlLmxvZ0luZm8oYFdlYlNvY2tldCwgY29ubmVjdGluZyB0byAke3RoaXMudXJsfWApO1xuICAgICAgICB0aGlzLnNvY2tldCA9IG5ldyB0aGlzLlNvY2tldCh0aGlzLnVybCArIGdldEZpbHRTdHIoYXJncyksIFtdKTtcbiAgICAgICAgdGhpcy5zb2NrZXQuYmluYXJ5VHlwZSA9IFwiYXJyYXlidWZmZXJcIjtcbiAgICAgICAgdGhpcy5zb2NrZXQuYWRkRXZlbnRMaXN0ZW5lcignb3BlbicsIGV2ZW50ID0+IHRoaXMub25PcGVuKGV2ZW50KSk7XG4gICAgICAgIHRoaXMuc29ja2V0LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBldmVudCA9PiB0aGlzLm9uTWVzc2FnZShldmVudCkpO1xuICAgICAgICB0aGlzLnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdjbG9zZScsIGV2ZW50ID0+IHRoaXMub25DbG9zZShldmVudCkpO1xuICAgICAgICB0aGlzLnNvY2tldC5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGV2ZW50ID0+IHRoaXMub25FcnJvcihldmVudCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25NZXNzYWdlKGV2ZW50KSB7XG4gICAgICAgIGlmIChldmVudC5kYXRhLmxlbmd0aCA9PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLnZvcnRleFN0YXR1c1NlcnZpY2UubG9nRXJyb3IoXCJXZWJTb2NrZXQsIFdlJ3ZlIHJlY2VpdmVkIGEgd2Vic29ja2V0IGJpbmFyeSBtZXNzYWdlLFwiICtcbiAgICAgICAgICAgICAgICBcIiB3ZSBleHBlY3QgYSB1bmljb2RlXCIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gSWYgdGhlIHNlcnZlciBzZW5kcyB1cyBhICcuJywgdGhhdCdzIGEgaGVhcnQgYmVhdCwgcmV0dXJuIGl0LlxuICAgICAgICBpZiAoZXZlbnQuZGF0YSA9PT0gJy4nKSB7XG4gICAgICAgICAgICB0aGlzLmJlYXQoKTtcbiAgICAgICAgICAgIHRoaXMuc29ja2V0ICE9IG51bGwgJiYgdGhpcy5zb2NrZXQuc2VuZCgnLicpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgUGF5bG9hZC5mcm9tVm9ydGV4TXNnKGV2ZW50LmRhdGEpXG4gICAgICAgICAgICAudGhlbigocGF5bG9hZDogUGF5bG9hZCkgPT4gdGhpcy5yZWNlaXZlKHBheWxvYWQpKVxuICAgICAgICAgICAgLmNhdGNoKGUgPT4gY29uc29sZS5sb2coYEVSUk9SIFZvcnRleENsaWVudFdlYnNvY2tldDogJHtlfWApKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uT3BlbihldmVudCkge1xuICAgICAgICB0aGlzLnZvcnRleFN0YXR1c1NlcnZpY2Uuc2V0T25saW5lKHRydWUpO1xuICAgICAgICB0aGlzLnNlbmRNZXNzYWdlcygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25DbG9zZShldmVudCkge1xuICAgICAgICB0aGlzLnZvcnRleFN0YXR1c1NlcnZpY2UubG9nSW5mbyhcIldlYlNvY2tldCwgY2xvc2VkXCIpO1xuICAgICAgICBpZiAoISh0aGlzLnNvY2tldCAmJiB0aGlzLnNvY2tldC5yZWFkeVN0YXRlID09PSB0aGlzLlNvY2tldC5PUEVOKSlcbiAgICAgICAgICAgIHRoaXMudm9ydGV4U3RhdHVzU2VydmljZS5zZXRPbmxpbmUoZmFsc2UpO1xuICAgICAgICAvLyBUaGUgYmFzZSBjbGFzcyB3aWxsIHJlY29ubmVjdFxuICAgIH1cblxuICAgIHByaXZhdGUgb25FcnJvcihldmVudCkge1xuICAgICAgICB0aGlzLnZvcnRleFN0YXR1c1NlcnZpY2UubG9nRXJyb3IoZXZlbnQuZXJyb3IgPyBldmVudC5lcnJvciA6IFwiV2ViU29ja2V0LCBObyBlcnJvciBtZXNzYWdlXCIpO1xuICAgICAgICAvLyBvbkNsb3NlIHdpbGwgZ2V0IGNhbGxlZCBhcyB3ZWxsXG4gICAgfVxuXG5cbn1cbiJdfQ==