"use strict";
/*
 * ###############################################################################
 * Common Serialisation functions
 * ###############################################################################
 */
Object.defineProperty(exports, "__esModule", { value: true });
var UtilMisc_1 = require("./UtilMisc");
var moment = require("moment");
var base64 = require('base-64');
var SerialiseUtil = (function () {
    function SerialiseUtil() {
    }
    SerialiseUtil.prototype.toStr = function (obj) {
        var self = this;
        if (obj["toISOString"] != null)
            return moment(obj).format(SerialiseUtil.ISO8601);
        if (obj.constructor === Boolean)
            return obj ? SerialiseUtil.V_TRUE : SerialiseUtil.V_FALSE;
        if (obj.constructor === String)
            return obj;
        return obj.toString();
    };
    SerialiseUtil.prototype.fromStr = function (val, typeName) {
        var self = this;
        if (typeName === SerialiseUtil.T_STR)
            return val;
        if (typeName === SerialiseUtil.T_BYTES)
            return base64.decode(encodeURI(val));
        if (typeName === SerialiseUtil.T_BOOL)
            return val === SerialiseUtil.V_TRUE;
        if (typeName === SerialiseUtil.T_FLOAT || typeName === SerialiseUtil.T_INT)
            return parseFloat(val);
        if (typeName === SerialiseUtil.T_DATETIME)
            return moment(val).toDate();
        alert("fromStr - UNKNOWN TYPE");
    };
    SerialiseUtil.prototype.toRapuiType = function (value) {
        var self = this;
        if (value == null)
            return SerialiseUtil.V_NULL;
        var TupleMod = require("./Tuple");
        var PayloadMod = require("./Payload");
        if (value instanceof TupleMod.Tuple)
            return SerialiseUtil.T_RAPUI_TUPLE;
        if (value instanceof PayloadMod.Payload)
            return SerialiseUtil.T_RAPUI_PAYLOAD;
        if (value instanceof Date)
            return SerialiseUtil.T_DATETIME;
        if (value.constructor === Number)
            return SerialiseUtil.T_FLOAT;
        if (value.constructor === String)
            return SerialiseUtil.T_STR;
        if (value.constructor === Boolean)
            return SerialiseUtil.T_BOOL;
        if (value.constructor === Array)
            return SerialiseUtil.T_LIST;
        if (value.constructor === Object)
            return SerialiseUtil.T_DICT;
        alert("toRapuiType - UNKNOWN TYPE");
    };
    SerialiseUtil.prototype.rapuiEquals = function (obj1, obj2, obj1FieldNames, obj2FieldNames) {
        var self = this;
        var fieldNames1 = obj1FieldNames;
        fieldNames1.sort();
        var fieldNames2 = obj2FieldNames;
        fieldNames2.sort();
        if (!fieldNames1.equals(fieldNames2))
            return false;
        // Create the <items> base element
        for (var fieldIndex = 0; fieldIndex < fieldNames1.length; ++fieldIndex) {
            var name_1 = fieldNames1[fieldIndex];
            var field1 = obj1[name_1];
            var field2 = obj2[name_1];
            if (field1 === undefined && field2 === undefined)
                continue;
            else if (field1 === undefined || field2 === undefined)
                return false;
            var type1 = self.toRapuiType(field1);
            var type2 = self.toRapuiType(field2);
            if (type1 !== type2)
                return false;
            if (type1 === SerialiseUtil.T_RAPUI_TUPLE
                || type1 === SerialiseUtil.T_RAPUI_PAYLOAD) {
                if (!field1.equals(field2))
                    return false;
            }
            else if (type1 === SerialiseUtil.T_LIST) {
                var indexes = [];
                for (var index = 0; index < field1.length; index++) {
                    indexes.push(index);
                }
                var isEqual = self.rapuiEquals(field1, field2, indexes, indexes);
                if (!isEqual)
                    return false;
            }
            else if (type1 === SerialiseUtil.T_DICT) {
                var isEqual = self.rapuiEquals(field1, field2, UtilMisc_1.dictKeysFromObject(field1), UtilMisc_1.dictKeysFromObject(field2));
                if (!isEqual)
                    return false;
            }
            else if (type1 === SerialiseUtil.T_DATETIME) {
                if (field1.getTime() !== field2.getTime())
                    return false;
            }
            else {
                if (field1 !== field2)
                    return false;
            }
        }
        return true;
    };
    SerialiseUtil.T_RAPUI_TUPLE = "rt";
    SerialiseUtil.T_RAPUI_PAYLOAD = "rp";
    SerialiseUtil.T_GENERIC_CLASS = "gen"; // NOT SUPPORTED
    SerialiseUtil.T_FLOAT = "float";
    SerialiseUtil.T_INT = "int";
    SerialiseUtil.T_STR = "str";
    SerialiseUtil.T_BYTES = "bytes";
    SerialiseUtil.T_BOOL = "bool";
    SerialiseUtil.T_DATETIME = "datetime";
    SerialiseUtil.T_DICT = "dict";
    SerialiseUtil.T_LIST = "list";
    SerialiseUtil.V_NULL = "null";
    SerialiseUtil.V_TRUE = "1";
    SerialiseUtil.V_FALSE = "0";
    SerialiseUtil.ISO8601_PY = "%Y-%m-%d %H:%M:%S.%f%z";
    SerialiseUtil.ISO8601 = "YYYY-MM-DD HH:mm:ss.SSSSSSZZ";
    return SerialiseUtil;
}());
exports.default = SerialiseUtil;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VyaWFsaXNlVXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlNlcmlhbGlzZVV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7O0FBRUgsdUNBQThDO0FBRzlDLCtCQUFpQztBQUNqQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFHaEM7SUFBQTtJQXFLQSxDQUFDO0lBM0lHLDZCQUFLLEdBQUwsVUFBTSxHQUFRO1FBQ1YsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRWhCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsSUFBSSxJQUFJLENBQUM7WUFDM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXJELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssT0FBTyxDQUFDO1lBQzVCLE1BQU0sQ0FBQyxHQUFHLEdBQUcsYUFBYSxDQUFDLE1BQU0sR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDO1FBRTlELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssTUFBTSxDQUFDO1lBQzNCLE1BQU0sQ0FBQyxHQUFHLENBQUM7UUFFZixNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFRCwrQkFBTyxHQUFQLFVBQVEsR0FBVyxFQUFFLFFBQWdCO1FBQ2pDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztRQUVoQixFQUFFLENBQUMsQ0FBQyxRQUFRLEtBQUssYUFBYSxDQUFDLEtBQUssQ0FBQztZQUNqQyxNQUFNLENBQUMsR0FBRyxDQUFDO1FBRWYsRUFBRSxDQUFDLENBQUMsUUFBUSxLQUFLLGFBQWEsQ0FBQyxPQUFPLENBQUM7WUFDbkMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FB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QUcsS0FBSyxDQUFDO0lBQ2QscUJBQU8sR0FBRyxPQUFPLENBQUM7SUFDbEIsb0JBQU0sR0FBRyxNQUFNLENBQUM7SUFDaEIsd0JBQVUsR0FBRyxVQUFVLENBQUM7SUFDeEIsb0JBQU0sR0FBRyxNQUFNLENBQUM7SUFDaEIsb0JBQU0sR0FBRyxNQUFNLENBQUM7SUFFaEIsb0JBQU0sR0FBRyxNQUFNLENBQUM7SUFDaEIsb0JBQU0sR0FBRyxHQUFHLENBQUM7SUFDYixxQkFBTyxHQUFHLEdBQUcsQ0FBQztJQUVkLHdCQUFVLEdBQUcsd0JBQXdCLENBQUM7SUFFdEMscUJBQU8sR0FBRyw4QkFBOEIsQ0FBQztJQWlKcEUsb0JBQUM7Q0FBQSxBQXJLRCxJQXFLQztrQkFyS29CLGFBQWEiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjI1xuICogQ29tbW9uIFNlcmlhbGlzYXRpb24gZnVuY3Rpb25zXG4gKiAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjXG4gKi9cblxuaW1wb3J0IHtkaWN0S2V5c0Zyb21PYmplY3R9IGZyb20gXCIuL1V0aWxNaXNjXCI7XG5cblxuaW1wb3J0ICogYXMgbW9tZW50IGZyb20gXCJtb21lbnRcIjtcbmxldCBiYXNlNjQgPSByZXF1aXJlKCdiYXNlLTY0Jyk7XG5cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2VyaWFsaXNlVXRpbCB7XG5cbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFRfUkFQVUlfVFVQTEUgPSBcInJ0XCI7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBUX1JBUFVJX1BBWUxPQUQgPSBcInJwXCI7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBUX0dFTkVSSUNfQ0xBU1MgPSBcImdlblwiOyAvLyBOT1QgU1VQUE9SVEVEXG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBUX0ZMT0FUID0gXCJmbG9hdFwiO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVF9JTlQgPSBcImludFwiO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVF9TVFIgPSBcInN0clwiO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVF9CWVRFUyA9IFwiYnl0ZXNcIjtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFRfQk9PTCA9IFwiYm9vbFwiO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVF9EQVRFVElNRSA9IFwiZGF0ZXRpbWVcIjtcbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFRfRElDVCA9IFwiZGljdFwiO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVF9MSVNUID0gXCJsaXN0XCI7XG5cbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IFZfTlVMTCA9IFwibnVsbFwiO1xuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgVl9UUlVFID0gXCIxXCI7XG4gICAgcHVibGljIHN0YXRpYyByZWFkb25seSBWX0ZBTFNFID0gXCIwXCI7XG5cbiAgICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IElTTzg2MDFfUFkgPSBcIiVZLSVtLSVkICVIOiVNOiVTLiVmJXpcIjtcblxuICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgSVNPODYwMSA9IFwiWVlZWS1NTS1ERCBISDptbTpzcy5TU1NTU1NaWlwiO1xuXG5cbiAgICAvLyBSYXB1aSBTZXJpYWxpc2VkIFR5cGUgLSAgU2hvcnRlbmVkIGZvciBtZW1vcnkgY29uc3RyYWludHMuXG4gICAgcHJvdGVjdGVkIF9fcnN0OiBzdHJpbmc7XG5cbiAgICB0b1N0cihvYmo6IGFueSk6IHN0cmluZyB7XG4gICAgICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgICAgICBpZiAob2JqW1widG9JU09TdHJpbmdcIl0gIT0gbnVsbCkgLy8gaW5zdGFuY2VvZiBEYXRlIG9yIG1vbWVudFxuICAgICAgICAgICAgcmV0dXJuIG1vbWVudChvYmopLmZvcm1hdChTZXJpYWxpc2VVdGlsLklTTzg2MDEpO1xuXG4gICAgICAgIGlmIChvYmouY29uc3RydWN0b3IgPT09IEJvb2xlYW4pXG4gICAgICAgICAgICByZXR1cm4gb2JqID8gU2VyaWFsaXNlVXRpbC5WX1RSVUUgOiBTZXJpYWxpc2VVdGlsLlZfRkFMU0U7XG5cbiAgICAgICAgaWYgKG9iai5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKVxuICAgICAgICAgICAgcmV0dXJuIG9iajtcblxuICAgICAgICByZXR1cm4gb2JqLnRvU3RyaW5nKCk7XG4gICAgfVxuXG4gICAgZnJvbVN0cih2YWw6IHN0cmluZywgdHlwZU5hbWU6IHN0cmluZyk6IGFueSB7XG4gICAgICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgICAgICBpZiAodHlwZU5hbWUgPT09IFNlcmlhbGlzZVV0aWwuVF9TVFIpXG4gICAgICAgICAgICByZXR1cm4gdmFsO1xuXG4gICAgICAgIGlmICh0eXBlTmFtZSA9PT0gU2VyaWFsaXNlVXRpbC5UX0JZVEVTKVxuICAgICAgICAgICAgcmV0dXJuIGJhc2U2NC5kZWNvZGUoZW5jb2RlVVJJKHZhbCkpO1xuXG4gICAgICAgIGlmICh0eXBlTmFtZSA9PT0gU2VyaWFsaXNlVXRpbC5UX0JPT0wpXG4gICAgICAgICAgICByZXR1cm4gdmFsID09PSBTZXJpYWxpc2VVdGlsLlZfVFJVRTtcblxuICAgICAgICBpZiAodHlwZU5hbWUgPT09IFNlcmlhbGlzZVV0aWwuVF9GTE9BVCB8fCB0eXBlTmFtZSA9PT0gU2VyaWFsaXNlVXRpbC5UX0lOVClcbiAgICAgICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHZhbCk7XG5cbiAgICAgICAgaWYgKHR5cGVOYW1lID09PSBTZXJpYWxpc2VVdGlsLlRfREFURVRJTUUpXG4gICAgICAgICAgICByZXR1cm4gbW9tZW50KHZhbCkudG9EYXRlKCk7XG5cbiAgICAgICAgYWxlcnQoXCJmcm9tU3RyIC0gVU5LTk9XTiBUWVBFXCIpO1xuICAgIH1cblxuICAgIHRvUmFwdWlUeXBlKHZhbHVlOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBsZXQgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpXG4gICAgICAgICAgICByZXR1cm4gU2VyaWFsaXNlVXRpbC5WX05VTEw7XG5cbiAgICAgICAgbGV0IFR1cGxlTW9kID0gcmVxdWlyZShcIi4vVHVwbGVcIik7XG4gICAgICAgIGxldCBQYXlsb2FkTW9kID0gcmVxdWlyZShcIi4vUGF5bG9hZFwiKTtcblxuICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBUdXBsZU1vZC5UdXBsZSlcbiAgICAgICAgICAgIHJldHVybiBTZXJpYWxpc2VVdGlsLlRfUkFQVUlfVFVQTEU7XG5cbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgUGF5bG9hZE1vZC5QYXlsb2FkKVxuICAgICAgICAgICAgcmV0dXJuIFNlcmlhbGlzZVV0aWwuVF9SQVBVSV9QQVlMT0FEO1xuXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpXG4gICAgICAgICAgICByZXR1cm4gU2VyaWFsaXNlVXRpbC5UX0RBVEVUSU1FO1xuXG4gICAgICAgIGlmICh2YWx1ZS5jb25zdHJ1Y3RvciA9PT0gTnVtYmVyKVxuICAgICAgICAgICAgcmV0dXJuIFNlcmlhbGlzZVV0aWwuVF9GTE9BVDtcblxuICAgICAgICBpZiAodmFsdWUuY29uc3RydWN0b3IgPT09IFN0cmluZylcbiAgICAgICAgICAgIHJldHVybiBTZXJpYWxpc2VVdGlsLlRfU1RSO1xuXG4gICAgICAgIGlmICh2YWx1ZS5jb25zdHJ1Y3RvciA9PT0gQm9vbGVhbilcbiAgICAgICAgICAgIHJldHVybiBTZXJpYWxpc2VVdGlsLlRfQk9PTDtcblxuICAgICAgICBpZiAodmFsdWUuY29uc3RydWN0b3IgPT09IEFycmF5KVxuICAgICAgICAgICAgcmV0dXJuIFNlcmlhbGlzZVV0aWwuVF9MSVNUO1xuXG4gICAgICAgIGlmICh2YWx1ZS5jb25zdHJ1Y3RvciA9PT0gT2JqZWN0KVxuICAgICAgICAgICAgcmV0dXJuIFNlcmlhbGlzZVV0aWwuVF9ESUNUO1xuXG4gICAgICAgIGFsZXJ0KFwidG9SYXB1aVR5cGUgLSBVTktOT1dOIFRZUEVcIik7XG4gICAgfVxuXG5cbiAgICByYXB1aUVxdWFscyhvYmoxOiBhbnksIG9iajI6IGFueSxcbiAgICAgICAgICAgICAgICBvYmoxRmllbGROYW1lczogc3RyaW5nW10sXG4gICAgICAgICAgICAgICAgb2JqMkZpZWxkTmFtZXM6IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBzZWxmID0gdGhpcztcblxuICAgICAgICBsZXQgZmllbGROYW1lczE6IHN0cmluZ1tdID0gb2JqMUZpZWxkTmFtZXM7XG4gICAgICAgIGZpZWxkTmFtZXMxLnNvcnQoKTtcblxuICAgICAgICBsZXQgZmllbGROYW1lczI6IHN0cmluZ1tdID0gb2JqMkZpZWxkTmFtZXM7XG4gICAgICAgIGZpZWxkTmFtZXMyLnNvcnQoKTtcblxuICAgICAgICBpZiAoIWZpZWxkTmFtZXMxLmVxdWFscyhmaWVsZE5hbWVzMikpXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgLy8gQ3JlYXRlIHRoZSA8aXRlbXM+IGJhc2UgZWxlbWVudFxuICAgICAgICBmb3IgKGxldCBmaWVsZEluZGV4ID0gMDsgZmllbGRJbmRleCA8IGZpZWxkTmFtZXMxLmxlbmd0aDsgKytmaWVsZEluZGV4KSB7XG4gICAgICAgICAgICBsZXQgbmFtZSA9IGZpZWxkTmFtZXMxW2ZpZWxkSW5kZXhdO1xuICAgICAgICAgICAgbGV0IGZpZWxkMSA9IG9iajFbbmFtZV07XG4gICAgICAgICAgICBsZXQgZmllbGQyID0gb2JqMltuYW1lXTtcblxuICAgICAgICAgICAgaWYgKGZpZWxkMSA9PT0gdW5kZWZpbmVkICYmIGZpZWxkMiA9PT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgZWxzZSBpZiAoZmllbGQxID09PSB1bmRlZmluZWQgfHwgZmllbGQyID09PSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICBsZXQgdHlwZTEgPSBzZWxmLnRvUmFwdWlUeXBlKGZpZWxkMSk7XG4gICAgICAgICAgICBsZXQgdHlwZTIgPSBzZWxmLnRvUmFwdWlUeXBlKGZpZWxkMik7XG5cbiAgICAgICAgICAgIGlmICh0eXBlMSAhPT0gdHlwZTIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICBpZiAodHlwZTEgPT09IFNlcmlhbGlzZVV0aWwuVF9SQVBVSV9UVVBMRVxuICAgICAgICAgICAgICAgIHx8IHR5cGUxID09PSBTZXJpYWxpc2VVdGlsLlRfUkFQVUlfUEFZTE9BRCkge1xuICAgICAgICAgICAgICAgIGlmICghZmllbGQxLmVxdWFscyhmaWVsZDIpKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZTEgPT09IFNlcmlhbGlzZVV0aWwuVF9MSVNUKSB7XG4gICAgICAgICAgICAgICAgbGV0IGluZGV4ZXMgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgZmllbGQxLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICAgICAgICAgICAgICBpbmRleGVzLnB1c2goaW5kZXgpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBpc0VxdWFsID0gc2VsZi5yYXB1aUVxdWFscyhmaWVsZDEsIGZpZWxkMiwgaW5kZXhlcywgaW5kZXhlcyk7XG4gICAgICAgICAgICAgICAgaWYgKCFpc0VxdWFsKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZTEgPT09IFNlcmlhbGlzZVV0aWwuVF9ESUNUKSB7XG4gICAgICAgICAgICAgICAgbGV0IGlzRXF1YWwgPSBzZWxmLnJhcHVpRXF1YWxzKGZpZWxkMSwgZmllbGQyLFxuICAgICAgICAgICAgICAgICAgICBkaWN0S2V5c0Zyb21PYmplY3QoZmllbGQxKSxcbiAgICAgICAgICAgICAgICAgICAgZGljdEtleXNGcm9tT2JqZWN0KGZpZWxkMikpO1xuICAgICAgICAgICAgICAgIGlmICghaXNFcXVhbClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUxID09PSBTZXJpYWxpc2VVdGlsLlRfREFURVRJTUUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZmllbGQxLmdldFRpbWUoKSAhPT0gZmllbGQyLmdldFRpbWUoKSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChmaWVsZDEgIT09IGZpZWxkMilcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG59XG4iXX0=